---
title: iOS构建提速
date: 2020-05-29 11:28:42
categories:
tags:
---

随着项目越来越大，代码量越来越多，编译的时间也越来越长，每次Clean Build一次都是漫长的等待，优化编译过程被提上日程。
<!-- more -->

## 0x00 预备知识
在优化之前，首先我们需要知道Xcode的整个编译过程的流程，以及流程中的每一部分的耗时。

在我们按下`Command + B`后，Xcode会执行以下几个步骤：
1. 执行当前`Schema`下的`Build`Action下的`Pre-actions`脚本（如果有）。
2. 生成辅助文件。
	2.1. 创建存放编译期间中间文件的目录`Intermediates.noindex`，通常是`DerivedData/[PROJECT_NAME]-对应ID/Build/Intermediates.noindex`。
	2.2. 创建`Products`目录，通常是`DerivedData/[PROJECT_NAME]-对应ID/Build/Products`。
	2.3. 在`Products`下生成对应文件架构的`.app`目录。
	2.4. 将`Entitlement`写入`build`目标下，并处理`Entitlement`文件。
	2.5. 生成`hmap`文件
3. 检查`Dependencies`，编译`Dependencies`。
接下来的步骤取决于`Build Phases`的顺序，我们插入的`Phases`会根据它在`Build Phases`中的顺序一个个执行。抛开自定义的`Phases`的执行流程如下：
4. 编译`Compile Sources`下的所有文件。
5. 链接`Link Binary With Libraries`下的framework和library。
6. 编译`xib`，`ImageAssets`，拷贝资源文件。
7. 处理`info.plist`。
8. 打包和签名。

使用命令`defaults write com.apple.dt.Xcode ShowBuildOperationDuration YES`开启显示Build的总时间。

使用`Product -> Perform Action -> Build With Timing Summary`编译后，在`Build Log`里会显示出此次Build的耗时Summary。

Xcode生成的`Build Log`不能很好的查看每个`Dependency`以及每个文件的编译时间，推荐使用[XCLogParser](https://github.com/spotify/XCLogParser)来更好的分析`Build Log`。


## 0x01 Build Settings
关于修改Build Settings来加快编译速度的文章网上也有很多，大致逃不过以下几个Settings:

### Build Active Architecture Only 改为 Yes
Debug时不需要生成全架构，检查一下子工程（尤其开源库）有没有设置正确。

### Debug下不生成dSYM文件
`Build Settings -> Build Options -> Debug Information Format`
`dSYM`文件中存放着函数地址于函数名的映射，当App Crash后，可以根据堆栈地址信息反解出具体的函数栈。但是在`Debug`时我们不需要它，因为Xcode会将`DWARF`调试信息写入`.o`文件中，所以在我们调试的时候，Xcode可以找到地址所对应的函数、方法。

### Debug下关闭Bitcode
`Bitcode`是`LLVM`使用的中间代码，有了它，`LLVM`可以使用它转换成任意架构的机器码。一般的Debug下也不需要，关了它能少一点开销是一点。

### 关闭Index-while-Building 
这个参数告诉编译器在编译的时候是否要同时建立索引，如果关闭了，Xcode就会在空闲的时间去建立索引。

### 避免search paths递归查找
如果你的`search path`被设置成了递归查找，并且`search path`下的目录结构非常复杂，那么将会是一项不小的开销。尽量使用非递归的查找方式。不过如果你的目录结构本来就很简单，文件也很少，那么这项优化可能对你的编译时间提升并没有太大的作用。

### Debug下设置Swift Optimization Level为None
避免编译器为编译swift代码做优化，设置为`-Onone`加快编译速度。

### Debug下设置Compilation Mode为Incremental
`Whole Module`模式会有更好的优化，但是也会增加编译时间。

## 0x02 模块化
正当你更改了所有可优化的设置，信心满满的`Clean Build`之后，可能你会发现你的编译时间的减少微乎其微，并且可能还变的更长了。现实就是这么残酷。
模块化可以说是减少编译时间最好的实践了，前有`CocoaPods`，后有`Carthage`，再到现在的`Swith Package Manager`。模块化是一项长期的工作，需要多方努力，但是效果显著。如果能将自己的工程拆分出一个个独立的模块那就是最好的方式了。

## 0x03 swift代码优化
如果你的项目里有swift代码，并且它在整个编译过程中的耗时占了很大的比例。那么你就可以开始着手优化你的swift代码了。
[BuildTimeAnalyzer-for-Xcode](https://github.com/RobertGummesson/BuildTimeAnalyzer-for-Xcode)是一个很优秀的辅助工具，它能帮助我们统计出编译时所有耗时的项目。swift的代码的编译优化在此就不提了，避免类型推断，拆文件避免改一行重新编译一堆文件，网上也有很多优秀的总结，总之swift，Emm，也就那样吧。

## 0x04 Objcive-C代码优化
Objc编译的瓶颈最可能出现在头文件的引用上。一是移除实际未使用的头文件，二是通过前置声名来代替`include/import`。如果想知道项目代码的编译时间的瓶颈到底是不是头文件引用，我们可以借助`Clang`的`-ftime-trace`参数来生成`Clang`的编译分析报告。但是很遗憾，当前版本的Xcode(Xcode 11)所集成的`Clang`还没有支持这个参数，所以我们需要让Xcode使用我们提供的`Clang`来编译我们的工程。在[这儿](https://github.com/llvm/llvm-project/releases)下载一个`Clang-10`。然后在Xcode中`Target -> Build Settings`点击`Levels`页卡边上的`+`，添加一个`User-Defined Setting`，将名字改成`CC`，再将其设置为我们的`Clang`可执行文件，这样就能让Xcode使用我们指定的`Clang`了。同时，在`Other C Flags`里添加一项`-ftime-trace`，大功告成。对于每个编译文件，都会对应生成一个`.json`文件，这些文件默认是和`.o`文件在同一个目录下，也就是`DerivedData/[PROJECT_NAME]-对应ID/Build/Intermediates.noindex/[PROJECT_NAME].build/Debug-iphonesimulator/[TARGET_NAME].build/Objects-normal/x86_64`（以simulator为例）。
生成的`.json`文件可以使用Chrome来查看，在Chrome的地址栏中输入`chrome://tracing`，加载`.json`文件，就能看见具体的耗时分析。如果觉得文件太多，可以写个脚本来合并这些文件，可以参考[这篇文章](https://www.snsystems.com/technology/tech-blog/clang-time-trace-feature)。
如果确定了是头文件引用太多造成的编译时间太长，除了上面提到的两个解决方案，还可以视情况把常用的头文件加入到`PCH`文件中，`PCH`文件中引用的头文件一旦改变，就会引起重编。
移除未使用的头文件以及使用前置声名来代替`include/import`看似是一件简单的事情，但是操作起来的工作量是非常大的，这篇[文章](https://cloud.tencent.com/developer/article/1564372)提供了一个很棒的实践，修改了[include-what-you-use](https://github.com/include-what-you-use/include-what-you-use)使之支持Objc来批量修改。

## 0x05 折中的模块化
在我们的项目里，





## Reference
[iOS编译过程的原理和应用](https://github.com/LeoMobileDeveloper/Blogs/blob/master/iOS/iOS%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E7%9A%84%E5%8E%9F%E7%90%86%E5%92%8C%E5%BA%94%E7%94%A8.md)
[Debug information “DWARF” and crash logs](https://stackoverflow.com/questions/54133246/debug-information-dwarf-and-crash-logs)
[iOS 微信编译速度优化分享](https://cloud.tencent.com/developer/article/1564372)
[TECH: Clang Time Trace Feature](https://www.snsystems.com/technology/tech-blog/clang-time-trace-feature)

MABarcodeReader  		1s
ChatEngine 				70s
DFCEngineDaemon
	DFCComUtil  		8s
	EngineLite  		3s
	Base 				1s
PDFReader 1				5s
ReportServiceCore 		118s
Inspector --
MSTRRssReader 			4s
MAMultimediaUploader 	4s
MSTRDataCloud			5s
SearchCore 				1s
DTCoreText 				1s
MSTRInfrastructureCore	10s

